#!/usr/bin/env sh

# Check if CHANGELOG has actual unreleased entries
# Extract content between ## [Unreleased] and next ## header
UNRELEASED_CONTENT=$(sed -n '/^## \[Unreleased\]/,/^## \[/p' CHANGELOG.md 2>/dev/null | sed '1d;$d' | grep -v '^$' | grep -v '^_' | grep -v '^---')

if [ -z "$UNRELEASED_CONTENT" ]; then
  # Check for feat/fix commits since last tag
  LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null)
  if [ -n "$LAST_TAG" ]; then
    COMMITS_SINCE_TAG=$(git log "$LAST_TAG"..HEAD --oneline 2>/dev/null)
  else
    COMMITS_SINCE_TAG=$(git log HEAD~50..HEAD --oneline 2>/dev/null)
  fi

  if echo "$COMMITS_SINCE_TAG" | grep -qE "^[a-f0-9]+ (feat|fix)"; then
    echo ""
    echo "⚠️  CHANGELOG.md hasn't been updated — did you forget to log changes?"
    echo "   Run: git log --oneline | head -20  to review recent commits"
    echo ""
  fi
fi

# Check if version is still 0.0.1 with significant features
VERSION=$(grep '"version"' package.json 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
if [ "$VERSION" = "0.0.1" ]; then
  FEAT_COUNT=$(git log --oneline 2>/dev/null | head -50 | grep -c "feat(" || true)
  if [ "$FEAT_COUNT" -gt 5 ]; then
    echo "⚠️  package.json still at 0.0.1 but $FEAT_COUNT feat commits found"
    echo ""
  fi
fi
