# KARIMO Greptile Review (Tier 3)
#
# Automated code review using Greptile. This workflow is optional and requires
# a GREPTILE_API_KEY secret to be configured. Without the API key, it gracefully
# skips review and applies the greptile-skipped label.
#
# Labels applied:
# - greptile-passed: Greptile score >= 3
# - greptile-needs-revision: Greptile score < 3
# - greptile-skipped: No API key configured

name: KARIMO Greptile Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-label:
    runs-on: ubuntu-latest
    outputs:
      is-karimo: ${{ steps.check.outputs.is-karimo }}
    steps:
      - name: Check for karimo label
        id: check
        run: |
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'karimo') }}" == "true" ]]; then
            echo "is-karimo=true" >> $GITHUB_OUTPUT
          else
            echo "is-karimo=false" >> $GITHUB_OUTPUT
          fi

  greptile-review:
    needs: check-label
    if: needs.check-label.outputs.is-karimo == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      statuses: write

    steps:
      - name: Check API Key
        id: api-check
        run: |
          if [ -z "${{ secrets.GREPTILE_API_KEY }}" ]; then
            echo "has-key=false" >> $GITHUB_OUTPUT
          else
            echo "has-key=true" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.api-check.outputs.has-key == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        if: steps.api-check.outputs.has-key == 'true'
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD > pr_diff.txt
          DIFF_SIZE=$(wc -l < pr_diff.txt)
          echo "diff-size=$DIFF_SIZE" >> $GITHUB_OUTPUT
          echo "PR diff size: $DIFF_SIZE lines"

      - name: Run Greptile Review
        id: greptile
        if: steps.api-check.outputs.has-key == 'true' && steps.diff.outputs.diff-size != '0'
        env:
          GREPTILE_API_KEY: ${{ secrets.GREPTILE_API_KEY }}
        run: |
          echo "Calling Greptile API for code review..."

          RESPONSE=$(curl -s -X POST "https://api.greptile.com/v1/review" \
            -H "Authorization: Bearer $GREPTILE_API_KEY" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "repository": "${{ github.repository }}",
            "pull_request": ${{ github.event.pull_request.number }},
            "base": "${{ github.event.pull_request.base.sha }}",
            "head": "${{ github.event.pull_request.head.sha }}"
          }
          EOF
          )

          # Check for API errors
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR=$(echo "$RESPONSE" | jq -r '.error')
            echo "Greptile API error: $ERROR"
            echo "score=0" >> $GITHUB_OUTPUT
            echo "error=true" >> $GITHUB_OUTPUT
            echo "error-message=$ERROR" >> $GITHUB_OUTPUT
          else
            SCORE=$(echo "$RESPONSE" | jq -r '.score // 0')
            echo "Greptile score: $SCORE"
            echo "score=$SCORE" >> $GITHUB_OUTPUT
            echo "error=false" >> $GITHUB_OUTPUT

            # Save response for comment
            echo "$RESPONSE" > greptile_response.json
          fi

      - name: Post Review Comment
        if: steps.api-check.outputs.has-key == 'true' && steps.greptile.outputs.error != 'true' && steps.diff.outputs.diff-size != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let response;
            try {
              response = JSON.parse(fs.readFileSync('greptile_response.json', 'utf8'));
            } catch (e) {
              console.log('No Greptile response to post');
              return;
            }

            const score = response.score || 0;
            const findings = response.findings || [];

            let body = `## KARIMO Code Review (Greptile)\n\n`;
            body += `**Score:** ${score}/5\n\n`;

            if (findings.length > 0) {
              body += `### Findings\n\n`;
              findings.forEach(f => {
                const icon = f.severity === 'error' ? '**Error:**' :
                             f.severity === 'warning' ? '**Warning:**' : '**Info:**';
                body += `${icon} ${f.title}\n`;
                body += `${f.description}\n`;
                if (f.file) body += `*File: \`${f.file}\`*\n`;
                body += `\n`;
              });
            } else {
              body += `No issues found.\n`;
            }

            body += `\n---\n*Reviewed by [Greptile](https://greptile.com) via KARIMO*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });

      - name: Apply Labels
        uses: actions/github-script@v7
        with:
          script: |
            const hasKey = '${{ steps.api-check.outputs.has-key }}' === 'true';
            const score = parseInt('${{ steps.greptile.outputs.score }}') || 0;
            const error = '${{ steps.greptile.outputs.error }}' === 'true';
            const diffSize = parseInt('${{ steps.diff.outputs.diff-size }}') || 0;

            const prNumber = context.payload.pull_request.number;

            // Determine which label to apply
            let label;
            if (!hasKey) {
              label = 'greptile-skipped';
            } else if (error || diffSize === 0) {
              // API error or no changes - treat as skipped
              label = 'greptile-skipped';
            } else if (score >= 3) {
              label = 'greptile-passed';
            } else {
              label = 'greptile-needs-revision';
            }

            console.log(`Applying label: ${label}`);

            // Remove any existing Greptile labels
            const greptileLabels = ['greptile-passed', 'greptile-needs-revision', 'greptile-skipped'];
            for (const l of greptileLabels) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: l
                });
              } catch (e) {
                // Label might not exist
              }
            }

            // Add the new label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [label]
            });

      - name: Post Skipped Comment
        if: steps.api-check.outputs.has-key != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            // Check if we've already posted this comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const marker = 'Greptile API key not configured';
            if (comments.find(c => c.body.includes(marker))) {
              console.log('Skipped comment already posted');
              return;
            }

            const body = `## KARIMO Code Review (Greptile)

**Greptile API key not configured.**

Automated code review is skipped. To enable Greptile review:

1. Get an API key from [greptile.com](https://greptile.com)
2. Add \`GREPTILE_API_KEY\` to your repository secrets
3. Push a new commit to re-trigger review

This PR has been labeled \`greptile-skipped\`.

*Note: KARIMO works without Greptile, but automated review significantly improves code quality outcomes.*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

      - name: Update PR Status
        if: steps.api-check.outputs.has-key == 'true' && steps.greptile.outputs.error != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const score = parseInt('${{ steps.greptile.outputs.score }}') || 0;
            const state = score >= 3 ? 'success' : 'failure';
            const description = score >= 3
              ? `Greptile score: ${score}/5`
              : `Greptile score: ${score}/5 - needs revision`;

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: state,
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${context.payload.pull_request.number}`,
              description: description,
              context: 'KARIMO / Greptile Review'
            });
